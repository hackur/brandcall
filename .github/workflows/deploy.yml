name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  ci:
    name: Run CI Checks
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  deploy:
    name: Deploy to Production
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://brandcall.io

    steps:
      - name: Trigger Envoyer Deployment
        run: |
          curl -X POST "${{ secrets.ENVOYER_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -d '{"sha": "${{ github.sha }}", "ref": "${{ github.ref }}"}'
        env:
          ENVOYER_DEPLOY_HOOK: ${{ secrets.ENVOYER_DEPLOY_HOOK }}

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ Deployment triggered for commit ${{ github.sha }}"
          echo "üöÄ Check Envoyer dashboard for deployment status"

      - name: Notify Failure
        if: failure()
        run: |
          echo "‚ùå Deployment trigger failed"
          exit 1
